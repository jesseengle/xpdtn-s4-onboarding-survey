
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XPDTN Season 4 Survey Results</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
        Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #121212;
      color: #fff;
      padding: 2rem;
    }
    .question-block { margin-bottom: 3rem; }
    .bar { margin: 0.5rem 0; }
    .bar-label { font-weight: 500; margin-bottom: 0.2rem; }
    .bar-fill {
      background: #9d5fbe;
      padding: 0.4rem;
      color: white;
      text-align: right;
      border-radius: 4px;
    }
    .bar-count { font-size: 0.85rem; opacity: 0.7; }
    .other-responses { margin-top: 1rem; font-size: 0.9rem; opacity: 0.8; }
  </style>
</head>
<body>
  <h1>XPDTN Season 4 Survey Results</h1>
  <div id="survey-container">Loading...</div>
  
<script>
// XPDTN S4 Onboarding Survey Dashboard (Fixed)

// Replace this URL with the live Sheet2API endpoint
const SHEET2API_URL =
  "https://sheet2api.com/v1/eVtBQ3lcSgaF/xpdtn-s4-onboarding-survey-live";

async function loadSurveyData() {
  const container = document.getElementById("survey-container");
  container.innerHTML = "Loading...";

  try {
    const response = await fetch(SHEET2API_URL);
    const data = await response.json();

    const headers = Object.keys(data[0]);
    console.log("ðŸ“Š Sheet Headers:", headers);

    const questions = getSurveyQuestions(headers);
    const formattedData = parseSheetData(data, questions, headers);

    container.innerHTML = "";
    questions.forEach((question) => {
      const questionData = formattedData[question];
      const section = renderQuestionBlock(question, questionData);
      container.appendChild(section);
    });
  } catch (error) {
    container.innerHTML = "Error loading survey data.";
    console.error("Failed to load survey data:", error);
  }
}

function getSurveyQuestions(headers) {
  return headers.filter((h) => h.startsWith("How") || h.startsWith("What"));
}

function parseSheetData(data, questions, headers) {
  const result = {};
  questions.forEach((q) => {
    const values = data.map((row) => row[q]);
    result[q] = parseQuestionData(q, values, data, headers);
  });
  return result;
}

function parseQuestionData(question, values, rows, headers) {
  const counts = {};
  const otherResponses = [];

  values.forEach((val, i) => {
    if (!val) return;
    const selections = val.split(",").map((v) => v.trim());
    selections.forEach((s) => {
      if (s.toLowerCase().startsWith("other")) {
        const openEnded = rows[i][headers.find((h) => h.toLowerCase().includes("other"))];
        if (openEnded) otherResponses.push(openEnded);
      } else {
        counts[s] = (counts[s] || 0) + 1;
      }
    });
  });

  return { counts, otherResponses };
}

function renderQuestionBlock(question, data) {
  const block = document.createElement("div");
  block.className = "question-block";

  const title = document.createElement("h2");
  title.innerText = question;
  block.appendChild(title);

  const total = Object.values(data.counts).reduce((a, b) => a + b, 0);

  Object.entries(data.counts)
    .sort((a, b) => b[1] - a[1])
    .forEach(([label, count]) => {
      const bar = document.createElement("div");
      bar.className = "bar";

      const percent = ((count / total) * 100).toFixed(0);

      bar.innerHTML = `
        <div class="bar-label">${label}</div>
        <div class="bar-fill" style="width: ${percent}%">${percent}%</div>
        <div class="bar-count">${count} responses</div>
      `;
      block.appendChild(bar);
    });

  if (data.otherResponses.length) {
    const other = document.createElement("div");
    other.className = "other-responses";
    other.innerHTML = `<strong>Other responses:</strong> ${data.otherResponses.join(
      ", "
    )}`;
    block.appendChild(other);
  }

  return block;
}

window.onload = loadSurveyData;
</script>

</body>
</html>
