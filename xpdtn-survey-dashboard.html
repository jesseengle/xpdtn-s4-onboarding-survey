<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>XPDTN Survey Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 2em;
    }
    h2 {
      color: #fff;
      margin-top: 3em;
    }
    .chart-container {
      margin-bottom: 60px;
      background: #1a1a1a;
      border-radius: 10px;
      padding: 20px;
    }
    canvas {
      max-width: 100%;
    }
    .other-responses {
      font-size: 0.9em;
      margin-top: 0.5em;
      color: #aaa;
    }
  </style>
</head>
<body>
  <div id="dashboard"></div>
  <script>
    const endpoint = "https://sheet2api.com/v1/eVtBQ3lcSgaF/xpdtn-s4-onboarding-survey-live";

    const chartConfigs = [
      {
        label: "How are you using AI today?",
        key: "Which of the following best describes how you’re using AI in your work today? (select all that apply)"
      },
      {
        label: "What’s your go-to AI tool?",
        key: "What’s your go-to AI tool (if any) in your current workflow?",
        normalize: true,
        threshold: 3
      },
      {
        label: "Confidence in using AI",
        key: "How confident are you in using AI tools in your creator marketing work?"
      },
      {
        label: "Areas of AI you want to learn about",
        key: "Which areas of AI are you most curious to learn more about this season? (pick top 3)"
      },
      {
        label: "Top priority for this season",
        key: "What’s your top priority for this season? (pick 1)"
      },
      {
        label: "Where you want to test AI tools",
        key: "Which areas of creator marketing would you be most interested in testing AI tools for?"
      }
    ];

    fetch(endpoint)
      .then(response => response.json())
      .then(data => {
        chartConfigs.forEach(config => {
          const rawValues = data.map(row => row[config.key]).filter(Boolean);
          let responses = [];

          rawValues.forEach(val => {
            val.split(/[;,\/]|\n/).forEach(part => {
              const trimmed = part.trim();
              if (trimmed) responses.push(trimmed);
            });
          });

          const countMap = {};

          if (config.normalize) {
            const normalized = responses.map(r => {
              const lc = r.toLowerCase();
              if (lc.includes("chatgpt") || lc.includes("chat gpt")) return "Chat GPT";
              if (lc.includes("claude")) return "Claude";
              if (lc.includes("gemini")) return "Gemini";
              return r;
            });

            normalized.forEach(r => {
              countMap[r] = (countMap[r] || 0) + 1;
            });

            const chartData = Object.entries(countMap)
              .filter(([label, count]) => count >= config.threshold && !["Chat GPT", "Claude", "Gemini"].includes(label))
              .map(([label, count]) => ({ label, count }));

            const knownLabels = ["Chat GPT", "Claude", "Gemini"];
            knownLabels.forEach(label => {
              if (countMap[label] >= config.threshold) {
                chartData.unshift({ label, count: countMap[label] });
              }
            });

            const others = Object.entries(countMap)
              .filter(([label, count]) =>
                count < config.threshold &&
                !["Chat GPT", "Claude", "Gemini"].includes(label)
              ).map(([label]) => label);

            renderChart(config.label, chartData, others);
          } else {
            responses.forEach(r => {
              countMap[r] = (countMap[r] || 0) + 1;
            });

            const chartData = Object.entries(countMap).map(([label, count]) => ({ label, count }));
            renderChart(config.label, chartData);
          }
        });
      });

    function renderChart(title, data, otherResponses = []) {
      const container = document.createElement("div");
      container.className = "chart-container";

      const heading = document.createElement("h2");
      heading.textContent = title;
      container.appendChild(heading);

      const canvas = document.createElement("canvas");
      container.appendChild(canvas);

      if (otherResponses.length) {
        const div = document.createElement("div");
        div.className = "other-responses";
        div.innerHTML = `<strong>Other responses:</strong> ${otherResponses.join(", ")}`;
        container.appendChild(div);
      }

      document.getElementById("dashboard").appendChild(container);

      new Chart(canvas.getContext("2d"), {
        type: "bar",
        data: {
          labels: data.map(d => d.label),
          datasets: [{
            label: "# of responses",
            data: data.map(d => d.count),
            backgroundColor: "#29d6bc"
          }]
        },
        options: {
          responsive: true,
          animation: {
            duration: 1000,
            easing: "easeOutBounce"
          },
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              ticks: { color: "#ccc" }
            },
            y: {
              ticks: { color: "#ccc" },
              beginAtZero: true
            }
          }
        }
      });
    }
  </script>
</body>
</html>
